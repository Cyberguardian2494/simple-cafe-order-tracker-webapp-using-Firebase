<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barista Dashboard</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 20px; background: #fafafa; }
    h1 { margin-bottom: 20px; }
    form { display: flex; gap: 10px; margin-bottom: 20px; }
    input, select, button { padding: 8px; font-size: 1rem; }
    .order { background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
    .order-info { display: grid; gap: 4px; }
    .status-select { padding: 4px; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="login">
    <h2>Barista login</h2>
    <form id="loginForm">
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- Dashboard (hidden until auth state is verified) -->
  <div id="dashboard" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h1>Barista dashboard</h1>
      <button id="logoutBtn">Logout</button>
    </div>

    <!-- Add Order Form -->
    <form id="orderForm">
      <input type="text" id="customerName" placeholder="Customer Name" required />
      <select id="drink" required>
        <option value="">Select Drink</option>
        <option value="Espresso">Espresso</option>
        <option value="Latte">Latte</option>
        <option value="Cappuccino">Cappuccino</option>
        <option value="Americano">Americano</option>
      </select>
      <button type="submit">Add Order</button>
    </form>

    <!-- Orders List -->
    <div id="orders"></div>
  </div>

  <script type="module">
    // Your Firebase config
    const firebaseConfig = {
      apiKey: "xxxx",
      authDomain: "xxxx.firebaseapp.com",
      projectId: "xxxx",
      storageBucket: "xxxx.appspot.com",
      messagingSenderId: "xxxx",
      appId: "xxxx"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, updateDoc, doc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginEl = document.getElementById("login");
    const dashboardEl = document.getElementById("dashboard");
    const loginForm = document.getElementById("loginForm");
    const loginError = document.getElementById("loginError");
    const logoutBtn = document.getElementById("logoutBtn");

    // Show/hide UI based on auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginEl.style.display = "none";
        dashboardEl.style.display = "block";
        startDashboard(); // start Firestore listeners only when authenticated
      } else {
        dashboardEl.style.display = "none";
        loginEl.style.display = "block";
        stopDashboard(); // optional: cleanup listeners
      }
    });

    // Login handler
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.textContent = "";
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        loginError.textContent = err.message;
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // Dashboard logic (runs only when logged in)
    let unsubscribe = null;
    function startDashboard() {
      const ordersRef = collection(db, "orders");

      const form = document.getElementById("orderForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("customerName").value;
        const drink = document.getElementById("drink").value;
        await addDoc(ordersRef, {
          customerName: name,
          drink,
          status: "In Progress",
          timeOrdered: serverTimestamp()
        });
        form.reset();
      });

      const ordersEl = document.getElementById("orders");
      const q = query(ordersRef, orderBy("timeOrdered", "desc"));

      unsubscribe = onSnapshot(q, (snapshot) => {
        ordersEl.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const orderDiv = document.createElement("div");
          orderDiv.className = "order";
          orderDiv.style = "background:#fff; border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center;";
          orderDiv.innerHTML = `
            <div>
              <strong>${data.customerName}</strong> â€” ${data.drink}
            </div>
            <select data-id="${docSnap.id}">
              <option value="In Progress" ${data.status === "In Progress" ? "selected" : ""}>In Progress</option>
              <option value="Ready" ${data.status === "Ready" ? "selected" : ""}>Ready</option>
              <option value="Completed" ${data.status === "Completed" ? "selected" : ""}>Completed</option>
            </select>
          `;
          ordersEl.appendChild(orderDiv);
        });

        document.querySelectorAll("select[data-id]").forEach(select => {
          select.addEventListener("change", async (e) => {
            const id = e.target.getAttribute("data-id");
            const newStatus = e.target.value;
            const orderDoc = doc(db, "orders", id);
            await updateDoc(orderDoc, {
              status: newStatus,
              ...(newStatus === "Completed" ? { timeCompleted: serverTimestamp() } : {})
            });
          });
        });
      });
    }

    function stopDashboard() {
      if (typeof unsubscribe === "function") {
        unsubscribe();
        unsubscribe = null;
      }
    }
  </script>
</body>
